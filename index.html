<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Аналитика эффективности менеджеров</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #222;
    }
    header {
      text-align: center;
      background: linear-gradient(90deg, #14b8a6, #0ea5e9);
      color: white;
      padding: 1.5rem;
      font-size: 1.8rem;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    #graph {
      width: 90%;
      max-width: 1200px;
      height: 700px;
      margin: 2rem auto;
      border-radius: 12px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      padding: 1rem;
      text-align: center;
      overflow: auto;
    }
    footer {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <header>Эффективность менеджеров: сентябрь → октябрь</header>

  <div id="graph">Загружаю данные...</div>

  <footer>Данные обновляются автоматически из Google Sheets © ReShape 2025</footer>

  <script>
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(loadData);

    function loadData() {
      const sheetURL = "https://docs.google.com/spreadsheets/d/1cY_gg2UPmv-zqjUuOXe5fnwhSnQTdPxZfspS_8-VPyc/gviz/tq?sheet=пропуск";
      console.log("Запрашиваю данные из:", sheetURL);
      const query = new google.visualization.Query(sheetURL);
      query.send(handleResponse);
    }

    function handleResponse(response) {
      const output = document.getElementById("graph");

      if (response.isError()) {
        output.innerText = "Ошибка загрузки данных";
        console.error("Google Visualization error:", response.getMessage());
        return;
      }

      const data = response.getDataTable();
      const numRows = data.getNumberOfRows();
      const numCols = data.getNumberOfColumns();

      console.log(`✅ Получено ${numRows} строк и ${numCols} колонок`);

      let headers = [];
      for (let c = 0; c < numCols; c++) {
        headers.push(data.getColumnLabel(c));
      }
      console.log("Заголовки:", headers);

      const idxSept = headers.indexOf("% Пришёл в сентябре");
      const idxOct = headers.indexOf("% Пришёл в октябре");
      const idxDelta = headers.indexOf("Δ % Пришёл");
      const idxPhone = headers.indexOf("Телефон");

      if (idxSept === -1 || idxOct === -1 || idxDelta === -1) {
        output.innerText = "Не удалось найти нужные столбцы. Проверь названия колонок.";
        console.warn("Колонки не найдены. Заголовки:", headers);
        return;
      }

      let x = [], y = [], delta = [], names = [];
      for (let i = 0; i < numRows; i++) {
        const sept = parseFloat(data.getValue(i, idxSept));
        const oct = parseFloat(data.getValue(i, idxOct));
        const d = parseFloat(data.getValue(i, idxDelta));
        const name = data.getValue(i, idxPhone);
        if (!isNaN(sept) && !isNaN(oct)) {
          x.push(sept);
          y.push(oct);
          delta.push(d);
          names.push(name);
        }
      }

      if (x.length === 0) {
        output.innerText = "Нет числовых данных для графика.";
        console.warn("Нет числовых значений.");
        return;
      }

      const scatter = {
        x, y,
        mode: "markers",
        type: "scatter",
        text: names,
        marker: {
          size: 8,
          color: delta,
          colorscale: "RdYlGn",
          colorbar: { title: "Δ % пришёл" },
          line: { width: 0.5, color: "DarkSlateGrey" }
        },
        name: "Клиенты"
      };

      const diagonal = {
        x: [0, 100],
        y: [0, 100],
        mode: "lines",
        line: { color: "gray", dash: "dot" },
        showlegend: false
      };

      const layout = {
        title: "Сравнение посещаемости клиентов: сентябрь → октябрь",
        xaxis: { title: "% пришёл в сентябре", range: [0, 100] },
        yaxis: { title: "% пришёл в октябре", range: [0, 100] },
        template: "plotly_white",
        width: 1100,
        height: 700
      };

      Plotly.newPlot("graph", [scatter, diagonal], layout);
    }
  </script>
</body>
</html>
